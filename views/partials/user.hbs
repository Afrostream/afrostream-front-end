<script>
  var tokenData;
  var url = '{{{config "apiClient.protocol"}}}://{{{config "apiClient.authority"}}}/api/users/me';
  var __USER_STATE__ = {
    _id: null
  };

  function getToken () {
    var storageId = '{{{config "apiClient.token"}}}';
    var storedData = localStorage.getItem(storageId);
    var resultData = null;
    if (storedData) {
      try {
        resultData = JSON.parse(storedData);
      } catch (err) {
        console.log('deserialize oauth data error');
      }
    }
    return resultData;
  }

  var randCallback = 'user' + String(Math.round(Math.random() * 100000));

  window[randCallback] = function (infoUser) {
    __USER_STATE__ = infoUser;
  }

  tokenData = getToken();

  if (tokenData && tokenData.access_token) {
    var accessToken = tokenData.access_token;
    document.write('<scr' + 'ipt src="' + url + '?' + accessToken + '&callback=' + randCallback + '"></scr' + 'ipt>');
  }
</script>
